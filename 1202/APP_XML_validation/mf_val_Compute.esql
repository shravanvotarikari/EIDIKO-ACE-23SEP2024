

CREATE COMPUTE MODULE mf_val_Compute
	CREATE FUNCTION Main() RETURNS BOOLEAN
	BEGIN
		-- CALL CopyMessageHeaders();
		 CALL CopyEntireMessage();
		RETURN TRUE;
	END;

	CREATE PROCEDURE CopyEntireMessage() BEGIN
		declare outref REFERENCE to OutputRoot.XMLNSC.Root.Body;
		
		IF FIELDNAME(outref.*) <> 'Data'  THEN
			
			declare bookref reference to  InputRoot.XMLNSC.Root.Body.*.book[1];
			DECLARE i INTEGER 1;
			WHILE LASTMOVE(bookref) DO
				call setqueue(InputRoot.XMLNSC.Root.Header.channelId);
				set OutputRoot.XMLNSC.Book = InputRoot.XMLNSC.Root.Body.*.*[i]; 
				propagate to TERMINAL 'out1';
				set i = i +1;
				move bookref NEXTSIBLING;
			end WHILE;
		end if;
	END;
	
	create PROCEDURE setqueue (in ch CHARACTER )
	BEGIN
		if ch = 'FCR' then
			set OutputLocalEnvironment.Destination.MQ.DestinationData.queueName = 'FCR';
		elseif ch = 'TPH' then
			set OutputLocalEnvironment.Destination.MQ.DestinationData.queueName = 'TPH';
		end if;
	END;
END MODULE;
